<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rpc example</title>
    <script type="application/javascript" src="../../qjsonchannel/simple-jsonrpc-js/simple-jsonrpc-js.js"></script>
    <script type="application/javascript" src="../../qjsonchannel/qjsonchannel.js"></script>
</head>

<body>
<h1 class="title"></h1>
<p class="paragraph"></p>
<script>
        //configure
        var jrpc = new simple_jsonrpc();

        jrpc.toStream = function(_msg){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState != 4) return;

                try {
                    jrpc.messageHandler(this.responseText);
                }
                catch (e){
                    console.error(e);
                }
            };

            xhr.open("POST", 'http://localhost:5555', true);
            xhr.setRequestHeader('Content-type', 'application/json');
            xhr.send(_msg);
        };

 
        new RpcWebChannel(jrpc, function(services) {
            let object = services.object;

            //
            // Method Calls
            //

            object.testMethod().then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.testMethod result: ' + result + '<br>';
            });

            object.testMethodWithParams("one", false, 10).then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.testMethodWithParams result: ' + result + '<br>';
            });

            object.testMethodWithParamsAndReturnValue ("kostya").then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.testMethodWithParamsAndReturnValue result: ' + result + '<br>';
            });

            //
            // Getter-Setter example
            //

            // Getter as function call
            object.getInvokable().then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.getInvokable    result: ' + result + '<br>';
            });

            // Setter as function call
            object.setInvokable("Hi 1").then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.setInvokable result: ' + result + '<br>';
            });

            (async function() {
                await (object.invokable = "Hi from JS");
                let invokable = await object.invokable;
    
                // synch access to property
                document.getElementsByClassName('paragraph')[0].innerHTML += 'invokable result: ' + invokable + '<br>';
            }());


        });

</script>
</body>

</html>