<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rpc example</title>
    <script type="application/javascript" src="../../qjsonchannel/simple-jsonrpc-js/simple-jsonrpc-js.js"></script>
    <script type="application/javascript" src="../../qjsonchannel/qjsonchannel.js"></script>
</head>

<body>
<h1 class="title"></h1>
<p class="paragraph"></p>
<script>
        //configure
        var jrpc = new simple_jsonrpc();

        jrpc.toStream = function(_msg){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState != 4) return;

                try {
                    jrpc.messageHandler(this.responseText);
                }
                catch (e){
                    console.error(e);
                }
            };

            xhr.open("POST", 'http://localhost:5555', true);
            xhr.setRequestHeader('Content-type', 'application/json');
            xhr.send(_msg);
        };

 
        new RpcWebChannel(jrpc, function(services) {
            let object = services.object;

            //
            // Slots calls
            //
            object.slot().then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.slot result: ' + result + '<br>';
            });

            object.slotWithParams("one", false, 10).then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.slotWithParams result: ' + result + '<br>';
            });

            object.slotWithParamsAndReturnValue ("kostya").then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.slotWithParamsAndReturnValue result: ' + result + '<br>';
            });

            // Invokable maethods calls
            object.invokableSetter("I'm setter").then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.invokableSetter result: ' + result + '<br>';
               
                // call Getter as function call
                object.invokableGetter().then(function (result) {
                    document.getElementsByClassName('paragraph')[0].innerHTML += 'object.invokableGetter    result: ' + result + '<br>';
                });
            });

            // Propertie access 
            object.setProperty("I'm setter").then(function (result) {
                document.getElementsByClassName('paragraph')[0].innerHTML += 'object.setProperty result: ' + result + '<br>';
               
                // call Getter as function call
                object.getProperty().then(function (result) {
                    document.getElementsByClassName('paragraph')[0].innerHTML += 'object.getProperty    result: ' + result + '<br>';
                });
            });

            // Anonymous local async function call is nedded for further await
            (async function() {
                // wait for setter finish
                await (object.propertyWithGetterSetter = 42);

                // wait for getter finish
                let property = await object.propertyWithGetterSetter;
    
                // synch access to property
                document.getElementsByClassName('paragraph')[0].innerHTML += 'propertyWithGetterSetter result: ' + property + '<br>';
            }());
        });

</script>
</body>

</html>